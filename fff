/* ... Kodun üst kısımları aynı ... */

    Flush_Smart_Buffer(); // Kalan son verileri yaz

    /* --- DEĞİŞİKLİK BURADA --- */
    
    // 1. Yeni slotu aktif et
    if (target_slot == SLOT_B_ADDR) {
        Set_Active_Slot(SLOT_B_ACTIVE);
    } else {
        Set_Active_Slot(SLOT_A_ACTIVE);
    }

    // 2. Başarı Mesajı
    printf("\r\n" CLR_GREEN "[BASARILI] Yukleme Tamamlandi!" CLR_RESET "\r\n");
    printf("Cache temizligi icin sistem yeniden baslatiliyor...\r\n");
    
    // 3. Mesajın gitmesi için minik bekleme
    HAL_Delay(500); 

    // 4. RESET AT (Bu sayede Cache silinir ve yeni kod görülür)
    HAL_NVIC_SystemReset();
    
    return;

EXIT_BUFFERED:
    HAL_UART_AbortReceive(&huart3);
    printf("\r\n[FAIL] Islem Basarisiz.\r\n");
}
