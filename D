/**
  * @brief  Hedef slota ait sayfaları siler (KESME KORUMALI & ICACHE TEMİZLİĞİ İLE).
  */
uint8_t Bootloader_Flash_Erase_Target_Slot(uint32_t slot_addr)
{
    FLASH_EraseInitTypeDef EraseInitStruct;
    uint32_t PageError;
    uint32_t StartPage;
    uint32_t BankNumber;

    /* Bank ve Sayfa Tespiti */
    if (slot_addr < FLASH_BANK2_START_ADDR)
    {
        // --- BANK 1 ---
        BankNumber = FLASH_BANK_1;
        StartPage = (slot_addr - FLASH_BASE) / FLASH_PAGE_SIZE;
        printf("[BILGI] Siliniyor: BANK 1, Page %lu, Adet: %d\r\n", StartPage, APP_NUM_PAGES_TO_ERASE);
    }
    else
    {
        // --- BANK 2 ---
        BankNumber = FLASH_BANK_2;
        // Bank 2 Offset Hesabı (Adres - 0x08200000)
        StartPage = (slot_addr - FLASH_BANK2_START_ADDR) / FLASH_PAGE_SIZE;
        printf("[BILGI] Siliniyor: BANK 2, Page %lu, Adet: %d\r\n", StartPage, APP_NUM_PAGES_TO_ERASE);
    }

    /* 1. KİLİT AÇMA VE FLAG TEMİZLİĞİ */
    HAL_FLASH_Unlock();
    __HAL_FLASH_CLEAR_FLAG(FLASH_FLAG_ALL_ERRORS);

    EraseInitStruct.TypeErase   = FLASH_TYPEERASE_PAGES;
    EraseInitStruct.Banks       = BankNumber;
    EraseInitStruct.Page        = StartPage;
    EraseInitStruct.NbPages     = APP_NUM_PAGES_TO_ERASE;

    /* 2. KRİTİK NOKTA: KESMELERİ KAPAT */
    /* Flash silinirken araya hiçbir şey girmemeli */
    __disable_irq();

    /* 3. SİLME İŞLEMİ */
    HAL_StatusTypeDef status = HAL_FLASHEx_Erase(&EraseInitStruct, &PageError);

    /* 4. KESMELERİ GERİ AÇ */
    __enable_irq();

    if (status != HAL_OK)
    {
        HAL_FLASH_Lock();
        printf("[HATA] Silme Basarisiz! PageError: %lu (Status: %d)\r\n", PageError, status);
        return 0;
    }

    /* 5. STM32U5 İÇİN CACHE TEMİZLİĞİ (Çok Önemli) */
    /* Flash içeriği değişti, Cache'i geçersiz kıl ki CPU yeni veriyi Flash'tan okusun */
    HAL_ICACHE_Invalidate(); 

    HAL_FLASH_Lock();
    printf("[BILGI] Silme Tamamlandi.\r\n");
    return 1;
}
